name: Semgrep

on:
  pull_request_target:
  push:
    branches: ["master", "main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  semgrep:
    name: Scan
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep:latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4

      # âœ… Run Semgrep with community rulepacks
      - name: Run Semgrep Scan
        run: |
          semgrep scan \
            --config=p/security-audit \
            --config=p/secrets \
            --config=p/ci \
            --json --output=semgrep.json

      # âœ… Parse JSON results and count findings
      - name: Count Semgrep findings
        id: counts
        run: |
          highs=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep.json)
          meds=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep.json)
          lows=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep.json)
          echo "high=$highs" >> $GITHUB_OUTPUT
          echo "medium=$meds" >> $GITHUB_OUTPUT
          echo "low=$lows" >> $GITHUB_OUTPUT

      # âœ… Comment summary directly on PR
      - name: Comment Semgrep results on PR
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âš¡ **Semgrep Security Scan**
            - ğŸ”´ High severity: ${{ steps.counts.outputs.high }}
            - ğŸŸ  Medium severity: ${{ steps.counts.outputs.medium }}
            - ğŸŸ¢ Low severity: ${{ steps.counts.outputs.low }}

            ğŸ“Š Please review and fix flagged issues before merging.
